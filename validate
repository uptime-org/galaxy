#!/bin/bash

echo "ðŸ§ª Galaxy Local Development Validation"
echo "======================================"

# Check Docker
echo -n "ðŸ“¦ Docker: "
if docker ps >/dev/null 2>&1; then
    echo "âœ… Running"
else
    echo "âŒ Not running - Start Docker Desktop first"
    exit 1
fi

# Check k8s
echo -n "âŽˆ Kubernetes: "
if kubectl cluster-info >/dev/null 2>&1; then
    echo "âœ… Connected"
    CONTEXT=$(kubectl config current-context)
    echo "   Context: $CONTEXT"
else
    echo "âŒ Not connected - Enable k8s in Docker Desktop"
    exit 1
fi

# Check Helm
echo -n "ðŸ›µ Helm: "
if command -v helm >/dev/null 2>&1; then
    echo "âœ… Available"
else
    echo "âŒ Not found - Install Helm"
    exit 1
fi

# Check ingress controller (optional)
echo -n "ðŸŒ Ingress Controller: "
if kubectl get pods -n ingress-nginx >/dev/null 2>&1; then
    echo "âœ… Available"
    INGRESS_AVAILABLE=true
else
    echo "âš ï¸  Not found (optional - see SETUP.md)"
    INGRESS_AVAILABLE=false
fi

echo ""
echo "ðŸ§ª Testing Galaxy App..."

# Test CI
echo "1. Running tests..."
if ./dev test >/dev/null 2>&1; then
    echo "   âœ… Tests passed"
else
    echo "   âš ï¸  Tests had issues (check ci-test/reports/)"
fi

# Test build
echo "2. Building image..."
if ./dev build >/dev/null 2>&1; then
    echo "   âœ… Image built: galaxy:dev"
    docker images galaxy:dev --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}\t{{.CreatedSince}}"
else
    echo "   âŒ Build failed"
    exit 1
fi

# Test deploy
echo "3. Deploying to k8s..."
if ./dev deploy 2>&1 | grep -q "Deployed"; then
    echo "   âœ… Deployed to namespace: local"
else
    echo "   âŒ Deploy failed"
    exit 1
fi

# Test access
echo "4. Testing access..."
sleep 5  # Wait for pod to be ready

if $INGRESS_AVAILABLE; then
    # Test with ingress
    echo "   Testing ingress access..."
    if kubectl get ingress -n local galaxy-local >/dev/null 2>&1; then
        echo "   âœ… Ingress created"
        echo "   ðŸ“ Add to /etc/hosts: echo '127.0.0.1 galaxy-local.localhost' | sudo tee -a /etc/hosts"
        echo "   ðŸŒ Then visit: http://galaxy-local.localhost"
    fi
else
    # Test with port-forward
    echo "   Testing service access..."
    if kubectl get svc -n local galaxy-local >/dev/null 2>&1; then
        echo "   âœ… Service created"
        echo "   ðŸ”Œ Access via: kubectl port-forward -n local svc/galaxy-local 8080:80"
        echo "   ðŸŒ Then visit: http://localhost:8080"
    fi
fi

# Show status
echo ""
echo "ðŸ“Š Current Status:"
kubectl get pods,svc,ingress -n local 2>/dev/null || echo "No resources found"

echo ""
echo "âœ… Validation Complete!"
echo ""
echo "ðŸš€ Quick Commands:"
echo "   ./dev run --clean    # Clean build and deploy"
echo "   kubectl logs -n local -l app.kubernetes.io/name=galaxy -f  # View logs"
echo "   helm uninstall galaxy-local -n local  # Clean up"