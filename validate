#!/bin/bash

echo "🧪 Galaxy Local Development Validation"
echo "======================================"

# Check Docker
echo -n "📦 Docker: "
if docker ps >/dev/null 2>&1; then
    echo "✅ Running"
else
    echo "❌ Not running - Start Docker Desktop first"
    exit 1
fi

# Check k8s
echo -n "⎈ Kubernetes: "
if kubectl cluster-info >/dev/null 2>&1; then
    echo "✅ Connected"
    CONTEXT=$(kubectl config current-context)
    echo "   Context: $CONTEXT"
else
    echo "❌ Not connected - Enable k8s in Docker Desktop"
    exit 1
fi

# Check Helm
echo -n "🛵 Helm: "
if command -v helm >/dev/null 2>&1; then
    echo "✅ Available"
else
    echo "❌ Not found - Install Helm"
    exit 1
fi

# Check ingress controller (optional)
echo -n "🌐 Ingress Controller: "
if kubectl get pods -n ingress-nginx >/dev/null 2>&1; then
    echo "✅ Available"
    INGRESS_AVAILABLE=true
else
    echo "⚠️  Not found (optional - see SETUP.md)"
    INGRESS_AVAILABLE=false
fi

echo ""
echo "🧪 Testing Galaxy App..."

# Test CI
echo "1. Running tests..."
if ./dev test >/dev/null 2>&1; then
    echo "   ✅ Tests passed"
else
    echo "   ⚠️  Tests had issues (check ci-test/reports/)"
fi

# Test build
echo "2. Building image..."
if ./dev build >/dev/null 2>&1; then
    echo "   ✅ Image built: galaxy:dev"
    docker images galaxy:dev --format "table {{.Repository}}:{{.Tag}}\t{{.Size}}\t{{.CreatedSince}}"
else
    echo "   ❌ Build failed"
    exit 1
fi

# Test deploy
echo "3. Deploying to k8s..."
if ./dev deploy 2>&1 | grep -q "Deployed"; then
    echo "   ✅ Deployed to namespace: local"
else
    echo "   ❌ Deploy failed"
    exit 1
fi

# Test access
echo "4. Testing access..."
sleep 5  # Wait for pod to be ready

if $INGRESS_AVAILABLE; then
    # Test with ingress
    echo "   Testing ingress access..."
    if kubectl get ingress -n local galaxy-local >/dev/null 2>&1; then
        echo "   ✅ Ingress created"
        echo "   📝 Add to /etc/hosts: echo '127.0.0.1 galaxy-local.localhost' | sudo tee -a /etc/hosts"
        echo "   🌐 Then visit: http://galaxy-local.localhost"
    fi
else
    # Test with port-forward
    echo "   Testing service access..."
    if kubectl get svc -n local galaxy-local >/dev/null 2>&1; then
        echo "   ✅ Service created"
        echo "   🔌 Access via: kubectl port-forward -n local svc/galaxy-local 8080:80"
        echo "   🌐 Then visit: http://localhost:8080"
    fi
fi

# Show status
echo ""
echo "📊 Current Status:"
kubectl get pods,svc,ingress -n local 2>/dev/null || echo "No resources found"

echo ""
echo "✅ Validation Complete!"
echo ""
echo "🚀 Quick Commands:"
echo "   ./dev run --clean    # Clean build and deploy"
echo "   kubectl logs -n local -l app.kubernetes.io/name=galaxy -f  # View logs"
echo "   helm uninstall galaxy-local -n local  # Clean up"